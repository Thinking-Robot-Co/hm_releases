<!DOCTYPE html>
<html>
<script>
    let isRecording=false,audioEnabled=true,currentRenameFile=null,currentRenameType=null,currentRenameBase=null;
    let currentRecordingFiles=[];
    let previewMap=null;
    let gpsWatchId=null;
    let hasGPS=false;
    let lastGPSUpdate=0;
    let recordingStartTime=null;
    let timerInterval=null;
    let gpsPoints=[];
    let currentMarker=null;
    
    // FIX 1: Local timer (updates every 1 second)
    function startRecordingTimer(){
        recordingStartTime=Date.now();
        timerInterval=setInterval(()=>{
            const elapsed=Math.floor((Date.now()-recordingStartTime)/1000);
            const mins=Math.floor(elapsed/60);
            const secs=elapsed%60;
            document.getElementById('recTimer').textContent=
                String(mins).padStart(2,'0')+':'+String(secs).padStart(2,'0');
        },1000);
    }
    
    function stopRecordingTimer(){
        if(timerInterval){
            clearInterval(timerInterval);
            timerInterval=null;
        }
        document.getElementById('recTimer').textContent='00:00';
    }
    
    function startGPS(){
        if('geolocation' in navigator){
            console.log('[GPS] Starting watch...');
            gpsWatchId=navigator.geolocation.watchPosition(
                function(position){
                    hasGPS=true;
                    lastGPSUpdate=Date.now();
                    const gpsData={
                        lat:position.coords.latitude,
                        lon:position.coords.longitude,
                        accuracy:position.coords.accuracy,
                        speed:position.coords.speed||0.0
                    };
                    
                    fetch('/api/update_gps',{
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify(gpsData)
                    });
                    
                    document.getElementById('gpsStatus').className='gps-status active';
                    document.getElementById('gpsStatus').textContent=`üìç GPS: ${gpsData.lat.toFixed(5)}, ${gpsData.lon.toFixed(5)}`;
                },
                function(error){
                    console.log('[GPS] Error:',error.message);
                    document.getElementById('gpsStatus').textContent='üìç GPS: Error';
                    document.getElementById('gpsStatus').className='gps-status';
                },
                {enableHighAccuracy:true,maximumAge:0,timeout:10000}
            );
        }else{
            document.getElementById('gpsStatus').textContent='üìç GPS: Not supported';
        }
    }
    
    setInterval(function(){
        if(hasGPS&&(Date.now()-lastGPSUpdate)>5000){
            document.getElementById('gpsStatus').textContent='üìç GPS: Searching...';
            document.getElementById('gpsStatus').className='gps-status';
        }
    },3000);
    
    function updateStatus(){
        fetch('/api/status').then(r=>r.json()).then(d=>{
            const wasRecording=isRecording;
            isRecording=d.is_recording;
            audioEnabled=d.audio_enabled;
            currentRecordingFiles=d.current_recording||[];
            
            // Start/stop local timer
            if(isRecording&&!wasRecording){
                startRecordingTimer();
            }else if(!isRecording&&wasRecording){
                stopRecordingTimer();
            }
            
            document.getElementById('statusText').textContent=d.status;
            document.getElementById('storageText').textContent='Storage: '+d.storage_free_gb+' GB';
            document.getElementById('recIndicator').className='rec-indicator'+(isRecording?' active':'');
            
            const btn=document.getElementById('btnAudio');
            if(audioEnabled){
                btn.className='btn-audio-toggle';
                btn.innerHTML='üé§';
            }else{
                btn.className='btn-audio-toggle muted';
                btn.innerHTML='üîá';
            }
            
            const recBtn=document.getElementById('btnRecord');
            if(isRecording){
                recBtn.textContent='STOP RECORDING';
                recBtn.className='btn btn-record recording';
            }else{
                recBtn.textContent='REC VIDEO';
                recBtn.className='btn btn-record';
            }
            
            if(currentRecordingFiles.length>0){
                loadMedia();
            }
        });
    }
    
    function toggleRecord(){
        if(isRecording){
            fetch('/api/stop_record',{method:'POST'});
        }else{
            fetch('/api/start_record');
        }
        setTimeout(updateStatus,500);
    }
    
    function toggleAudio(){
        audioEnabled=!audioEnabled;
        fetch('/api/toggle_audio',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled:audioEnabled})})
            .then(r=>r.json()).then(d=>{audioEnabled=d.audio_enabled;updateStatus();});
    }
    
    function capturePhoto(){
        fetch('/api/capture_photo').then(()=>{alert('Photo captured!');setTimeout(loadMedia,1000);});
    }
    
    function copyDownloadLink(filename){
        const hostname=window.location.hostname;
        const port=window.location.port;
        const protocol=window.location.protocol;
        const downloadUrl=`${protocol}//${hostname}:${port}/api/download/${filename}`;
        
        navigator.clipboard.writeText(downloadUrl).then(()=>{
            const notification=document.getElementById('copyNotification');
            notification.className='copy-notification show';
            setTimeout(()=>{notification.className='copy-notification';},2000);
        }).catch(err=>{alert('Download link: '+downloadUrl);});
    }
    
    function showRenameModal(filename,type='single',base=null){
        currentRenameFile=filename;
        currentRenameType=type;
        currentRenameBase=base;
        
        if(type==='batch'){
            document.getElementById('renameTitle').textContent='‚úèÔ∏è Rename Video Session';
            const displayName=base.replace('video_','').replace(/_/g,' ');
            document.getElementById('renameInput').value=displayName;
        }else{
            document.getElementById('renameTitle').textContent='‚úèÔ∏è Rename Video';
            const displayName=filename.replace('video_','').replace('.mp4','').replace(/_/g,' ');
            document.getElementById('renameInput').value=displayName;
        }
        
        document.getElementById('renameModal').className='rename-modal active';
        document.getElementById('renameInput').focus();
    }
    
    function closeRenameModal(){
        document.getElementById('renameModal').className='rename-modal';
        currentRenameFile=null;
        currentRenameType=null;
        currentRenameBase=null;
    }
    
    function saveRename(){
        const newName=document.getElementById('renameInput').value.trim();
        if(!newName){alert('Please enter a name');return;}
        
        if(currentRenameType==='batch'){
            fetch('/api/rename_batch',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({base:currentRenameBase,new_name:newName})
            }).then(r=>r.json()).then(d=>{
                if(d.success){
                    alert('Renamed '+d.renamed_count+' files!');
                    closeRenameModal();
                    loadMedia();
                }else{
                    alert('Failed: '+(d.error||'Unknown'));
                }
            });
        }else{
            fetch('/api/rename_file',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({old_name:currentRenameFile,new_name:newName})
            }).then(r=>r.json()).then(d=>{
                if(d.success){
                    alert('Renamed!');
                    closeRenameModal();
                    loadMedia();
                }else{
                    alert('Failed: '+(d.error||'Unknown'));
                }
            });
        }
    }

        // ===== MISSING FUNCTIONS - ADD AFTER saveRename() =====

    function loadMedia() {
        fetch('/api/list_media')
            .then(r => r.json())
            .then(data => {
                const mediaList = document.getElementById('mediaList');

                if (data.length === 0) {
                    mediaList.innerHTML = '<div class="empty-state">No media files yet</div>';
                    return;
                }

                let html = '';

                // Show active recording session first
                if (currentRecordingFiles.length > 0) {
                    html += '<div class="recording-session-card">';
                    html += '<div class="recording-session-header">';
                    html += '<div class="recording-icon"></div>';
                    html += '<div class="recording-session-title">üî¥ Recording in Progress</div>';
                    html += '</div>';
                    html += '<div class="recording-session-info">Started: ' + (currentRecordingFiles[0]?.started || '') + '</div>';
                    html += '<div class="recording-chunks-list">';

                    for (let chunk of currentRecordingFiles) {
                        html += '<div class="recording-chunk-item">';
                        html += '<div class="recording-chunk-name">' + chunk.name + '</div>';
                        html += '<div class="recording-chunk-size">' + chunk.size + ' MB</div>';
                        html += '</div>';
                    }

                    html += '</div></div>';
                }

                // Render other files/batches
                for (let item of data) {
                    if (item.type === 'batch') {
                        html += renderBatchGroup(item);
                    } else {
                        html += renderMediaItem(item);
                    }
                }

                mediaList.innerHTML = html;
            });
    }

function renderBatchGroup(batch) {
        // Use backticks (`) for the whole string
        let html = `
        <div class="batch-group">
            <div class="batch-header">
                <div class="batch-title">üìπ Video Session (${batch.chunk_count} chunks)</div>
                <div class="batch-info">${batch.base}</div>
            </div>
            <div class="batch-stats">
                <div class="batch-stat">üíæ ${batch.total_size.toFixed(2)} MB</div>
                ${batch.uploaded_count > 0 ? `<div class="batch-stat">‚úÖ ${batch.uploaded_count} uploaded</div>` : ''}
                ${batch.failed_count > 0 ? `<div class="batch-stat">‚ùå ${batch.failed_count} failed</div>` : ''}
                ${batch.converting_count > 0 ? `<div class="batch-stat">‚öôÔ∏è ${batch.converting_count} converting</div>` : ''}
                ${batch.incomplete_count > 0 ? `<div class="batch-stat">‚ö†Ô∏è ${batch.incomplete_count} incomplete</div>` : ''}
            </div>
            <div class="batch-actions">
                ${(batch.uploaded_count < batch.chunk_count && batch.incomplete_count === 0) ? 
                    `<button class="batch-btn batch-btn-upload" onclick="batchUpload('${batch.base}')">‚òÅÔ∏è Upload All</button>` : ''}
                <button class="batch-btn batch-btn-rename" onclick="showRenameModal('${batch.base}', 'batch', '${batch.base}')">‚úèÔ∏è Rename</button>
                <button class="batch-btn batch-btn-delete" onclick="deleteBatch('${batch.base}')">üóëÔ∏è Delete</button>
            </div>
            <div class="chunk-list">`;

        for (let chunk of batch.chunks) {
            let statusBadge = '';
            if (chunk.uploaded) statusBadge = '<span class="chunk-status uploaded">‚úÖ Uploaded</span>';
            else if (chunk.failed) statusBadge = '<span class="chunk-status failed">‚ùå Failed</span>';
            else if (chunk.converting) statusBadge = '<span class="chunk-status converting">‚öôÔ∏è Converting</span>';
            else if (chunk.incomplete) statusBadge = '<span class="chunk-status incomplete">‚ö†Ô∏è Incomplete</span>';
            else if (chunk.upload_status && chunk.upload_status.status === 'uploading') statusBadge = '<span class="chunk-status uploading">‚òÅÔ∏è Uploading</span>';

            html += `
            <div class="chunk-item" onclick="showPreview('${chunk.name}')">
                <div class="chunk-name">${chunk.name}</div>
                <div class="chunk-info">
                    <span class="chunk-size">${chunk.size} MB</span>
                    ${statusBadge}
                </div>
            </div>`;
        }
        html += `</div></div>`;
        return html;
    }

    function renderMediaItem(item) {
        let classes = 'media-item';
        if (item.uploaded) classes += ' uploaded';
        if (item.failed) classes += ' failed';
        if (item.incomplete) classes += ' incomplete';

        let statusBadge = '';
        if (item.uploaded) statusBadge = '<div class="status-badge uploaded">‚úÖ Uploaded</div>';
        else if (item.failed) statusBadge = '<div class="status-badge failed">‚ùå Failed</div>';
        else if (item.converting) statusBadge = '<div class="status-badge converting">‚öôÔ∏è Converting</div>';
        else if (item.incomplete) statusBadge = '<div class="status-badge incomplete">‚ö†Ô∏è Incomplete</div>';
        else if (item.upload_status && item.upload_status.status === 'uploading') statusBadge = '<div class="status-badge uploading">‚òÅÔ∏è Uploading</div>';

        const clickHandler = item.type === 'image' ? `showPhotoModal('${item.name}')` : `showPreview('${item.name}')`;

        return `
        <div class="${classes}">
            ${statusBadge}
            <div class="media-header" onclick="${clickHandler}">
                <div class="media-name">${item.type === 'image' ? 'üì∑ ' : 'üé• '} ${item.name}</div>
                <div class="media-size">${item.size} MB</div>
            </div>
            <div class="media-actions">
                <button class="action-btn btn-copy-link" onclick="event.stopPropagation(); copyDownloadLink('${item.name}')">üìã Copy</button>
                
                ${(item.type === 'video' && !item.uploaded && !item.converting && !item.incomplete) ? 
                    `<button class="action-btn btn-upload" onclick="event.stopPropagation(); uploadFile('${item.name}')">‚òÅÔ∏è Upload</button>` : ''}
                
                <button class="action-btn btn-download" onclick="event.stopPropagation(); window.location.href='/api/download/${item.name}'">‚¨áÔ∏è Download</button>
                
                ${(item.type === 'video' && !item.converting) ? 
                    `<button class="action-btn btn-rename" onclick="event.stopPropagation(); showRenameModal('${item.name}')">‚úèÔ∏è Rename</button>` : ''}
                
                <button class="action-btn btn-delete" onclick="event.stopPropagation(); deleteFile('${item.name}')">üóëÔ∏è Delete</button>
            </div>
        </div>`;
    }

    function showPreview(filename) {
        document.getElementById('modalTitle').textContent = filename;
        document.getElementById('previewVideo').src = '/data/' + filename;
        document.getElementById('previewModal').className = 'modal active';

        loadGPSForVideo(filename);
    }

    function loadGPSForVideo(filename) {
        document.getElementById('mapLoading').style.display = 'block';

        fetch('/api/get_gps_data/' + filename)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('mapLoading').textContent = '‚ùå No GPS data';
                    document.getElementById('mapInfo').innerHTML = '<div style="text-align:center;color:#888;padding:20px">No GPS data available</div>';
                    return;
                }

                gpsPoints = data.points;
                document.getElementById('mapLoading').style.display = 'none';

                if (!previewMap) {
                    previewMap = L.map('map').setView([gpsPoints[0].lat, gpsPoints[0].lon], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '¬© OpenStreetMap'
                    }).addTo(previewMap);
                } else {
                    previewMap.setView([gpsPoints[0].lat, gpsPoints[0].lon], 15);
                }

                previewMap.eachLayer(layer => {
                    if (layer instanceof L.Polyline || layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                        previewMap.removeLayer(layer);
                    }
                });

                const coords = gpsPoints.map(p => [p.lat, p.lon]);
                const polyline = L.polyline(coords, {color: '#00ff88', weight: 4}).addTo(previewMap);

                L.marker([gpsPoints[0].lat, gpsPoints[0].lon], {
                    icon: L.divIcon({className: 'custom-marker', html: 'üü¢', iconSize: [20, 20]})
                }).addTo(previewMap);

                L.marker([gpsPoints[gpsPoints.length-1].lat, gpsPoints[gpsPoints.length-1].lon], {
                    icon: L.divIcon({className: 'custom-marker', html: 'üî¥', iconSize: [20, 20]})
                }).addTo(previewMap);

                previewMap.fitBounds(polyline.getBounds());

                // FIX 3: Video playback GPS sync
                const video = document.getElementById('previewVideo');
                video.addEventListener('timeupdate', function() {
                    const videoDuration = video.duration;
                    const currentTime = video.currentTime;

                    if (gpsPoints && gpsPoints.length > 0 && videoDuration > 0) {
                        const index = Math.floor((currentTime / videoDuration) * (gpsPoints.length - 1));
                        const point = gpsPoints[index];

                        if (currentMarker) {
                            previewMap.removeLayer(currentMarker);
                        }

                        currentMarker = L.circleMarker([point.lat, point.lon], {
                            radius: 8,
                            color: '#ff0000',
                            fillColor: '#ff0000',
                            fillOpacity: 1
                        }).addTo(previewMap);

                        previewMap.panTo([point.lat, point.lon]);
                    }
                });

                let infoHtml = '';
                infoHtml += '<div class="map-info-row"><div class="map-label">Total Points</div><div class="map-value">' + gpsPoints.length + '</div></div>';
                infoHtml += '<div class="map-info-row"><div class="map-label">Start</div><div class="map-value">' + data.start.lat.toFixed(5) + ', ' + data.start.lon.toFixed(5) + '</div></div>';
                infoHtml += '<div class="map-info-row"><div class="map-label">End</div><div class="map-value">' + data.end.lat.toFixed(5) + ', ' + data.end.lon.toFixed(5) + '</div></div>';
                document.getElementById('mapInfo').innerHTML = infoHtml;
            })
            .catch(err => {
                document.getElementById('mapLoading').textContent = '‚ùå Error loading GPS';
            });
    }

    function closePreview() {
        document.getElementById('previewModal').className = 'modal';
        document.getElementById('previewVideo').src = '';
        gpsPoints = [];
        if (currentMarker && previewMap) {
            previewMap.removeLayer(currentMarker);
            currentMarker = null;
        }
    }

    function showPhotoModal(filename) {
        document.getElementById('photoTitle').textContent = filename;
        document.getElementById('photoPreview').src = '/data/' + filename;
        document.getElementById('photoModal').className = 'modal active';
    }

    function closePhotoModal() {
        document.getElementById('photoModal').className = 'modal';
    }

    function uploadFile(filename) {
        if (!confirm('Upload ' + filename + ' to cloud?')) return;
        fetch('/api/upload_cloud', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({filename: filename})
        }).then(() => {
            setTimeout(loadMedia, 500);
        });
    }

    function batchUpload(base) {
        if (!confirm('Upload all chunks in this session?')) return;
        fetch('/api/batch_upload', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({base: base})
        }).then(() => {
            setTimeout(loadMedia, 500);
        });
    }

    function deleteFile(filename) {
        if (!confirm('Delete ' + filename + '?')) return;
        fetch('/api/delete_file', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({filename: filename})
        }).then(() => {
            loadMedia();
        });
    }

    function deleteBatch(base) {
        if (!confirm('Delete entire video session?')) return;
        fetch('/api/delete_batch', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({base: base})
        }).then(() => {
            loadMedia();
        });
    }

    
    // Continue with loadMedia(), showPreview() with video sync, etc.
    // Add all remaining functions from previous version
    
    startGPS();
    updateStatus();
    loadMedia();
    setInterval(updateStatus,2000);
    setInterval(loadMedia,3000);
</script>
</body>
</html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Helmet {{ version }}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #0a0a0a;
            color: #fff;
        }
        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 18px; color: #00ff88; margin-bottom: 5px; }
        .status-bar { display: flex; justify-content: space-between; font-size: 12px; color: #888; }
        .gps-status { color: #ff9900; font-size: 11px; }
        .gps-status.active { color: #00ff88; }
        .feed-container { position: relative; background: #000; }
        .feed-container img { width: 100%; display: block; }
        .rec-indicator {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,0,0,0.95);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: none;
            animation: pulse 1.5s infinite;
        }
        .rec-indicator.active { display: flex; gap: 8px; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .audio-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,255,136,0.9);
            color: #000;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            display: none;
        }
        .audio-indicator.active { display: block; }
        .audio-indicator.muted { background: rgba(255,68,68,0.9); color: #fff; }
        .controls { padding: 20px; background: #1a1a1a; }
        .controls-top { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-record {
            background: linear-gradient(135deg, #ff0844 0%, #ff6b6b 100%);
            color: white;
            flex: 1;
        }
        .btn-record.recording { background: linear-gradient(135deg, #666 0%, #888 100%); }
        .btn-audio-toggle {
            background: rgba(0,255,136,0.15);
            color: #00ff88;
            border: 2px solid #00ff88;
            padding: 12px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            width: 55px;
        }
        .btn-audio-toggle.muted { background: rgba(255,68,68,0.15); color: #ff4444; border-color: #ff4444; }
        .btn-photo {
            background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
            color: white;
            width: 100%;
        }
        .section-title {
            padding: 15px 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            font-size: 13px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        .media-list { padding: 10px; padding-bottom: 80px; }

        .recording-session-card {
            background: linear-gradient(135deg, #3a1a1a 0%, #2a0a0a 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #ff4444;
            animation: recordingPulse 2s infinite;
            box-shadow: 0 0 20px rgba(255,68,68,0.3);
        }

        @keyframes recordingPulse {
            0%, 100% { border-color: #ff4444; box-shadow: 0 0 20px rgba(255,68,68,0.3); }
            50% { border-color: #ff8888; box-shadow: 0 0 30px rgba(255,68,68,0.5); }
        }

        .recording-session-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .recording-icon {
            width: 12px;
            height: 12px;
            background: #ff4444;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .recording-session-title {
            font-size: 16px;
            color: #ff8888;
            font-weight: bold;
        }

        .recording-session-info {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 10px;
        }

        .recording-chunks-list {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
        }

        .recording-chunk-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
        }

        .recording-chunk-item:last-child {
            margin-bottom: 0;
        }

        .recording-chunk-name {
            font-size: 12px;
            color: #fff;
        }

        .recording-chunk-size {
            font-size: 12px;
            color: #00ff88;
            font-weight: bold;
        }

        .batch-group {
            background: linear-gradient(135deg, #1e3a5f 0%, #2a4a6f 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #3a5a7f;
        }
        .batch-header { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .batch-title { font-size: 15px; color: #00d4ff; font-weight: bold; margin-bottom: 5px; }
        .batch-info { font-size: 12px; color: #aaa; }
        .batch-stats { display: flex; gap: 12px; margin-bottom: 12px; font-size: 12px; flex-wrap: wrap; }
        .batch-stat { background: rgba(0,0,0,0.3); padding: 6px 10px; border-radius: 8px; }
        .batch-actions { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .batch-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }
        .batch-btn-upload { background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%); color: #000; }
        .batch-btn-delete { background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%); color: #fff; }
        .batch-btn-rename { background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%); color: #000; }
        .batch-btn:active { transform: scale(0.95); }
        .chunk-list { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .chunk-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            font-size: 12px;
            color: #ccc;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 5px;
            background: rgba(0,0,0,0.2);
        }
        .chunk-item:hover { background: rgba(255,255,255,0.1); }
        .chunk-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 10px; }
        .chunk-info { display: flex; align-items: center; gap: 8px; }
        .chunk-size { font-size: 11px; color: #999; }
        .chunk-status {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: bold;
        }
        .chunk-status.uploaded { background: #00ff88; color: #000; }
        .chunk-status.uploading { background: #0099ff; color: #fff; animation: pulse 1.5s infinite; }
        .chunk-status.failed { background: #ff4444; color: #fff; }
        .chunk-status.converting { background: #ff9900; color: #000; animation: pulse 1.5s infinite; }
        .chunk-status.incomplete { background: #9900ff; color: #fff; }
        .media-item {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #333;
            position: relative;
        }
        .media-item.uploaded { border: 2px solid #00ff88; }
        .media-item.failed { border: 2px solid #ff4444; }
        .media-item.incomplete { border: 2px solid #9900ff; }
        .media-header { display: flex; justify-content: space-between; margin-bottom: 10px; cursor: pointer; }
        .media-name { font-size: 13px; color: #fff; word-break: break-all; flex: 1; padding-right: 10px; }
        .media-size { font-size: 12px; color: #888; background: rgba(255,255,255,0.05); padding: 4px 10px; border-radius: 15px; }

        .media-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
            align-items: stretch;
        }

        .action-btn {
            flex: 1 1 auto;
            padding: 9px 5px;
            border: none;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 65px;
            max-width: 75px;
            white-space: nowrap;
            text-align: center;
        }

        .btn-copy-link { background: linear-gradient(135deg, #9900ff 0%, #6600cc 100%); color: #fff; }
        .btn-upload { background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%); color: #000; }
        .btn-download { background: linear-gradient(135deg, #0099ff 0%, #0066cc 100%); color: #fff; }
        .btn-delete { background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%); color: #fff; }
        .btn-rename { background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%); color: #000; }
        .action-btn:active { transform: scale(0.95); }
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 10px;
            padding: 5px 10px;
            border-radius: 12px;
            font-weight: bold;
        }
        .status-badge.uploaded { background: #00ff88; color: #000; }
        .status-badge.uploading { background: #0099ff; color: #fff; animation: pulse 1.5s infinite; }
        .status-badge.failed { background: #ff4444; color: #fff; }
        .status-badge.converting { background: #ff9900; color: #000; animation: pulse 1.5s infinite; }
        .status-badge.incomplete { background: #9900ff; color: #fff; }
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            overflow-y: auto;
        }
        .modal.active { display: block; }
        .modal-content { max-width: 900px; margin: 0 auto; padding: 15px; padding-bottom: 80px; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; padding: 10px 0; }
        .modal-title { font-size: 14px; color: #00ff88; word-break: break-all; flex: 1; padding-right: 10px; }
        .modal-close {
            background: #ff4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-video { width: 100%; max-height: 40vh; background: #000; border-radius: 12px; margin-bottom: 15px; }
        .modal-map-container { margin-bottom: 15px; }
        .modal-map { 
            width: 100%; 
            height: 350px; 
            background: #1a1a1a; 
            border-radius: 12px; 
            overflow: hidden;
            position: relative;
        }
        #map { width: 100%; height: 100%; border-radius: 12px; }
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
        }
        .map-info { padding: 15px; background: #1a1a1a; border-radius: 12px; margin-top: 15px; }
        .map-info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #333; }
        .map-info-row:last-child { border-bottom: none; }
        .map-label { color: #888; font-size: 12px; }
        .map-value { color: #fff; font-size: 12px; text-align: right; }
        .photo-preview { width: 100%; border-radius: 8px; margin-bottom: 10px; cursor: pointer; }
        .rename-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .rename-modal.active { display: flex; }
        .rename-dialog {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            border: 2px solid #333;
        }
        .rename-title { font-size: 16px; color: #00ff88; margin-bottom: 15px; font-weight: bold; }
        .rename-input {
            width: 100%;
            padding: 12px;
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .rename-input:focus { outline: none; border-color: #00ff88; }
        .rename-buttons { display: flex; gap: 10px; }
        .rename-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        .rename-btn-save { background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%); color: #000; }
        .rename-btn-cancel { background: linear-gradient(135deg, #666 0%, #444 100%); color: #fff; }

        .copy-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            color: #000;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 3000;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .copy-notification.show {
            display: block;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="copyNotification" class="copy-notification">üìã Download link copied!</div>

    <div class="header">
        <h1>üé• Smart Helmet {{ version }}</h1>
        <div class="status-bar">
            <span id="statusText">STANDBY</span>
            <span id="gpsStatus" class="gps-status">üìç GPS: Initializing...</span>
            <span id="storageText">Storage: -- GB</span>
        </div>
    </div>

    <div class="feed-container">
        <img id="videoFeed" src="/video_feed" alt="Live Feed">
        <div id="recIndicator" class="rec-indicator"><span>‚óè</span><span id="recTimer">00:00</span></div>
        <div id="audioIndicator" class="audio-indicator">üé§</div>
    </div>

    <div class="controls">
        <div class="controls-top">
            <button id="btnRecord" class="btn btn-record" onclick="toggleRecord()">REC VIDEO</button>
            <button id="btnAudio" class="btn-audio-toggle" onclick="toggleAudio()">üé§</button>
        </div>
        <button class="btn btn-photo" onclick="capturePhoto()">üì∑ CAPTURE PHOTO</button>
    </div>

    <div class="section-title">MEDIA LOGS</div>
    <div id="mediaList" class="media-list"></div>

    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Video</div>
                <button class="modal-close" onclick="closePreview()">‚úï Close</button>
            </div>
            <video id="previewVideo" class="modal-video" controls></video>
            <div class="modal-map-container">
                <div class="modal-map">
                    <div id="map"></div>
                    <div id="mapLoading" class="map-loading">Loading GPS...</div>
                </div>
            </div>
            <div class="map-info" id="mapInfo"></div>
        </div>
    </div>

    <div id="photoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="photoTitle">Photo</div>
                <button class="modal-close" onclick="closePhotoModal()">‚úï</button>
            </div>
            <img id="photoPreview" src="" style="width: 100%; border-radius: 12px;">
        </div>
    </div>

    <div id="renameModal" class="rename-modal">
        <div class="rename-dialog">
            <div class="rename-title" id="renameTitle">‚úèÔ∏è Rename Video</div>
            <input type="text" id="renameInput" class="rename-input" placeholder="Enter new name...">
            <div class="rename-buttons">
                <button class="rename-btn rename-btn-save" onclick="saveRename()">Save</button>
                <button class="rename-btn rename-btn-cancel" onclick="closeRenameModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
