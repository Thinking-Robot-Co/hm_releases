<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Helmet {{ version }}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .header h1 {
            font-size: 18px;
            color: #00ff88;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #888;
        }

        .feed-container {
            position: relative;
            width: 100%;
            background: #000;
        }

        .feed-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        .rec-indicator {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 0, 0, 0.95);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: none;
            animation: pulse 1.5s infinite;
            box-shadow: 0 4px 15px rgba(255,0,0,0.4);
        }

        .rec-indicator.active {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rec-timer {
            font-variant-numeric: tabular-nums;
            letter-spacing: 1px;
            font-size: 14px;
        }

        .audio-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 255, 136, 0.90);
            color: #000;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            display: none;
            box-shadow: 0 4px 15px rgba(0,255,136,0.3);
        }

        .audio-indicator.active { display: block; }
        .audio-indicator.muted { background: rgba(255, 68, 68, 0.90); color: #fff; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .controls {
            padding: 20px;
            background: #1a1a1a;
        }

        .controls-top {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: stretch;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .btn:active { transform: scale(0.98); }

        .btn-record {
            background: linear-gradient(135deg, #ff0844 0%, #ff6b6b 100%);
            color: white;
            flex: 1;
        }

        .btn-record.recording {
            background: linear-gradient(135deg, #666 0%, #888 100%);
        }

        .btn-audio-toggle {
            background: rgba(0, 255, 136, 0.15);
            color: #00ff88;
            border: 2px solid #00ff88;
            padding: 12px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            width: 55px;
            flex-shrink: 0;
        }

        .btn-audio-toggle:active { transform: scale(0.95); }
        .btn-audio-toggle.muted { background: rgba(255, 68, 68, 0.15); color: #ff4444; border-color: #ff4444; }

        .btn-photo {
            background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
            color: white;
            width: 100%;
        }

        .section-title {
            padding: 15px 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            font-size: 13px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }

        .media-list {
            padding: 10px;
            padding-bottom: 80px;
        }

        .recording-card {
            background: linear-gradient(135deg, #3a1a1a 0%, #2a0a0a 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #ff4444;
            animation: recordingPulse 2s infinite;
            box-shadow: 0 0 20px rgba(255,68,68,0.3);
        }

        @keyframes recordingPulse {
            0%, 100% { border-color: #ff4444; box-shadow: 0 0 20px rgba(255,68,68,0.3); }
            50% { border-color: #ff8888; box-shadow: 0 0 30px rgba(255,68,68,0.5); }
        }

        .recording-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .recording-icon {
            width: 12px;
            height: 12px;
            background: #ff4444;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .recording-title {
            font-size: 14px;
            color: #ff8888;
            font-weight: bold;
        }

        .recording-info {
            font-size: 12px;
            color: #ccc;
            margin-top: 5px;
        }

        .recording-size {
            font-size: 12px;
            color: #00ff88;
            font-weight: bold;
        }

        .batch-group {
            background: linear-gradient(135deg, #1e3a5f 0%, #2a4a6f 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #3a5a7f;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .batch-header {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .batch-title {
            font-size: 15px;
            color: #00d4ff;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .batch-info {
            font-size: 12px;
            color: #aaa;
        }

        .batch-stats {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 12px;
            flex-wrap: wrap;
        }

        .batch-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0,0,0,0.3);
            padding: 6px 10px;
            border-radius: 8px;
        }

        .batch-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .batch-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .batch-btn-upload {
            background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            color: #000;
        }

        .batch-btn-delete {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: #fff;
        }

        .batch-btn:active { transform: scale(0.95); }

        .chunk-list {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .chunk-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            font-size: 12px;
            color: #ccc;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 6px;
            margin-bottom: 5px;
            background: rgba(0,0,0,0.2);
        }

        .chunk-item:hover { background: rgba(255,255,255,0.1); }

        .chunk-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }

        .chunk-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .chunk-size {
            font-size: 11px;
            color: #999;
        }

        .chunk-status {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: bold;
            white-space: nowrap;
        }

        .chunk-status.uploaded { background: #00ff88; color: #000; }
        .chunk-status.uploading { background: #0099ff; color: #fff; animation: pulse 1.5s infinite; }
        .chunk-status.failed { background: #ff4444; color: #fff; }
        .chunk-status.converting { background: #ff9900; color: #000; animation: pulse 1.5s infinite; }
        .chunk-status.recording { background: #ff4444; color: #fff; animation: blink 1s infinite; }

        .media-item {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #333;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .media-item.uploaded {
            border: 2px solid #00ff88;
            background: linear-gradient(135deg, #1a3a2a 0%, #0a2a1a 100%);
        }

        .media-item.failed {
            border: 2px solid #ff4444;
            background: linear-gradient(135deg, #3a1a1a 0%, #2a0a0a 100%);
        }

        .media-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .media-name {
            font-size: 13px;
            color: #fff;
            word-break: break-all;
            flex: 1;
            padding-right: 10px;
        }

        .media-size {
            font-size: 12px;
            color: #888;
            background: rgba(255,255,255,0.05);
            padding: 4px 10px;
            border-radius: 15px;
            white-space: nowrap;
        }

        .media-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-upload { background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%); color: #000; }
        .btn-download { background: linear-gradient(135deg, #0099ff 0%, #0066cc 100%); color: #fff; }
        .btn-delete { background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%); color: #fff; }
        .btn-rename { background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%); color: #000; }

        .action-btn:active { transform: scale(0.95); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 10px;
            padding: 5px 10px;
            border-radius: 12px;
            font-weight: bold;
        }

        .status-badge.uploaded { background: #00ff88; color: #000; }
        .status-badge.uploading { background: #0099ff; color: #fff; animation: pulse 1.5s infinite; }
        .status-badge.failed { background: #ff4444; color: #fff; }
        .status-badge.converting { background: #ff9900; color: #000; animation: pulse 1.5s infinite; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .empty-state-hint {
            font-size: 12px;
            color: #555;
        }

        .photo-preview {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal.active { display: block; }

        .modal-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 15px;
            padding-bottom: 80px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
        }

        .modal-title {
            font-size: 14px;
            color: #00ff88;
            word-break: break-all;
            flex: 1;
            padding-right: 10px;
        }

        .modal-close {
            background: #ff4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            flex-shrink: 0;
        }

        .modal-close:active { transform: scale(0.95); }

        .modal-video {
            width: 100%;
            max-height: 40vh;
            background: #000;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .modal-map-container {
            margin-bottom: 15px;
        }

        .modal-map {
            width: 100%;
            height: 350px;
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 12px;
        }

        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
        }

        .map-info {
            padding: 15px;
            background: #1a1a1a;
            border-radius: 12px;
            margin-top: 15px;
        }

        .map-info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }

        .map-info-row:last-child { border-bottom: none; }

        .map-label {
            color: #888;
            font-size: 12px;
            flex-shrink: 0;
            margin-right: 15px;
        }

        .map-value {
            color: #fff;
            font-size: 12px;
            text-align: right;
        }

        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.98);
            z-index: 1000;
            overflow-y: auto;
        }

        .photo-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-modal-content {
            max-width: 100%;
            padding: 20px;
        }

        .photo-modal img {
            width: 100%;
            height: auto;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .rename-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .rename-modal.active { display: flex; }

        .rename-dialog {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            border: 2px solid #333;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        .rename-title {
            font-size: 16px;
            color: #00ff88;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .rename-input {
            width: 100%;
            padding: 12px;
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .rename-input:focus {
            outline: none;
            border-color: #00ff88;
        }

        .rename-buttons {
            display: flex;
            gap: 10px;
        }

        .rename-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rename-btn-save {
            background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            color: #000;
        }

        .rename-btn-cancel {
            background: linear-gradient(135deg, #666 0%, #444 100%);
            color: #fff;
        }

        .rename-btn:active { transform: scale(0.95); }

        @media (max-width: 600px) {
            .modal-map { height: 280px; }
            .modal-video { max-height: 35vh; }
            .batch-stats { gap: 8px; }
            .batch-stat { font-size: 11px; padding: 4px 8px; }
            .action-btn { font-size: 10px; padding: 8px; min-width: 60px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé• Smart Helmet {{ version }}</h1>
        <div class="status-bar">
            <span id="statusText">STANDBY</span>
            <span id="storageText">Storage: -- GB</span>
        </div>
    </div>

    <div class="feed-container">
        <img id="videoFeed" src="/video_feed" alt="Live Feed">
        <div id="recIndicator" class="rec-indicator">
            <span>‚óè</span>
            <span class="rec-timer" id="recTimer">00:00</span>
        </div>
        <div id="audioIndicator" class="audio-indicator">üé§</div>
    </div>

    <div class="controls">
        <div class="controls-top">
            <button id="btnRecord" class="btn btn-record" onclick="toggleRecord()">REC VIDEO</button>
            <button id="btnAudio" class="btn-audio-toggle" onclick="toggleAudio()" title="Toggle Audio">üé§</button>
        </div>
        <button class="btn btn-photo" onclick="capturePhoto()">üì∑ CAPTURE PHOTO</button>
    </div>

    <div class="section-title">MEDIA LOGS</div>
    <div id="mediaList" class="media-list"></div>

    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Video Preview</div>
                <button class="modal-close" onclick="closePreview()">‚úï Close</button>
            </div>
            <video id="previewVideo" class="modal-video" controls></video>
            <div class="modal-map-container">
                <div class="modal-map">
                    <div id="map"></div>
                    <div id="mapLoading" class="map-loading">Loading GPS...</div>
                </div>
            </div>
            <div class="map-info" id="mapInfo"></div>
        </div>
    </div>

    <div id="photoModal" class="photo-modal">
        <div class="photo-modal-content">
            <div class="modal-header">
                <div class="modal-title" id="photoTitle">Photo</div>
                <button class="modal-close" onclick="closePhotoPreview()">‚úï</button>
            </div>
            <img id="photoPreview" src="" alt="Photo">
            <div class="map-info" id="photoInfo"></div>
        </div>
    </div>

    <div id="renameModal" class="rename-modal">
        <div class="rename-dialog">
            <div class="rename-title">‚úèÔ∏è Rename Video</div>
            <input type="text" id="renameInput" class="rename-input" placeholder="Enter new name...">
            <div class="rename-buttons">
                <button class="rename-btn rename-btn-save" onclick="saveRename()">Save</button>
                <button class="rename-btn rename-btn-cancel" onclick="closeRenameModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let isRecording=false,gpsWatchId=null,recordingStartTime=0,timerInterval=null,previewMap=null,audioEnabled=true,currentRenameFile=null,currentRecordingFiles=[];function formatTime(e){const t=Math.floor(e/60),n=e%60;return String(t).padStart(2,"0")+":"+String(n).padStart(2,"0")}function updateRecordingTimer(){if(isRecording){const e=Math.floor((Date.now()-recordingStartTime)/1e3);document.getElementById("recTimer").textContent=formatTime(e)}}function startGPS(){"geolocation"in navigator&&(gpsWatchId=navigator.geolocation.watchPosition(e=>{fetch("/api/update_gps",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lat:e.coords.latitude,lon:e.coords.longitude,accuracy:e.coords.accuracy,speed:e.coords.speed||0})}).catch(e=>console.log("GPS:",e))},e=>console.log("GPS:",e),{enableHighAccuracy:!0,maximumAge:1e3}))}function updateAudioUI(){const e=document.getElementById("btnAudio"),t=document.getElementById("audioIndicator");audioEnabled?(e.className="btn-audio-toggle",e.innerHTML="üé§",e.title="Audio ON",t.className="audio-indicator"+(isRecording?" active":""),t.textContent="üé§"):(e.className="btn-audio-toggle muted",e.innerHTML="üîá",e.title="Audio OFF",t.className="audio-indicator muted"+(isRecording?" active":""),t.textContent="üîá")}function toggleAudio(){audioEnabled=!audioEnabled,fetch("/api/toggle_audio",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enabled:audioEnabled})}).then(e=>e.json()).then(e=>{audioEnabled=e.audio_enabled,updateAudioUI()}).catch(e=>console.log("Audio:",e))}function updateStatus(){fetch("/api/status").then(e=>e.json()).then(e=>{const t=isRecording;isRecording=e.is_recording,audioEnabled=e.audio_enabled,currentRecordingFiles=e.current_recording||[],document.getElementById("statusText").textContent=e.status,document.getElementById("storageText").textContent="Storage: "+e.storage_free_gb+" GB",document.getElementById("recIndicator").className="rec-indicator"+(isRecording?" active":""),updateAudioUI();const n=document.getElementById("btnRecord");isRecording?(n.textContent="STOP RECORDING",n.className="btn btn-record recording",t||(recordingStartTime=Date.now()-1e3*e.recording_time,timerInterval&&clearInterval(timerInterval),timerInterval=setInterval(updateRecordingTimer,1e3)),updateRecordingTimer()):(n.textContent="REC VIDEO",n.className="btn btn-record",timerInterval&&(clearInterval(timerInterval),timerInterval=null)),(isRecording||currentRecordingFiles.length>0)&&loadMedia()}).catch(e=>console.log("Status:",e))}function toggleRecord(){isRecording?fetch("/api/stop_record",{method:"POST"}).catch(e=>console.log("Stop:",e)):fetch("/api/start_record").catch(e=>console.log("Start:",e)),setTimeout(updateStatus,500)}function capturePhoto(){fetch("/api/capture_photo").then(()=>{alert("Photo captured!"),setTimeout(loadMedia,1e3)}).catch(()=>alert("Failed"))}function showRenameModal(e){currentRenameFile=e;const t=e.replace("video_","").replace(".mp4","").replace(/_/g," ");document.getElementById("renameInput").value=t,document.getElementById("renameModal").className="rename-modal active",document.getElementById("renameInput").focus()}function closeRenameModal(){document.getElementById("renameModal").className="rename-modal",currentRenameFile=null}function saveRename(){const e=document.getElementById("renameInput").value.trim();if(!e)return void alert("Please enter a name");fetch("/api/rename_file",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({old_name:currentRenameFile,new_name:e})}).then(e=>e.json()).then(e=>{e.success?(alert("Renamed!"),closeRenameModal(),loadMedia()):alert("Failed: "+(e.error||"Unknown"))}).catch(()=>alert("Failed"))}function loadMedia(){fetch("/api/list_media").then(e=>e.json()).then(e=>{const t=document.getElementById("mediaList");let n="";if(currentRecordingFiles.length>0&&currentRecordingFiles.forEach(e=>{n+=`<div class="recording-card"><div class="recording-header"><div class="recording-icon"></div><div class="recording-title">üé¨ RECORDING...</div></div><div class="recording-info">${e.name}</div><div class="recording-info">Started: ${e.started}</div><div class="recording-size">‚óè ${e.size} MB (Live)</div></div>`}),0===e.length&&0===currentRecordingFiles.length)return void(t.innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h18V4H4c-1.1 0-2 .9-2 2v11H0v3h14v-3H4V6zm19 2h-6c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1zm-1 9h-4v-7h4v7z"/></svg><div class="empty-state-text">No media yet</div><div class="empty-state-hint">Start recording</div></div>');e.forEach(e=>{if("batch"===e.type){const t=e.converting_count>0?'<div class="batch-stat">‚öôÔ∏è '+e.converting_count+" converting</div>":"";n+=`<div class="batch-group"><div class="batch-header"><div class="batch-title">üìπ Video Session</div><div class="batch-info">${e.base.replace("video_","").replace(/_/g," ")}</div></div><div class="batch-stats"><div class="batch-stat">üì¶ ${e.chunk_count} chunks</div><div class="batch-stat">üíæ ${e.total_size.toFixed(1)} MB</div><div class="batch-stat">‚úì ${e.uploaded_count}/${e.chunk_count} uploaded</div>${t}</div><div class="batch-actions"><button class="batch-btn batch-btn-upload" onclick="batchUpload('${e.base}')">‚òÅÔ∏è Upload All</button><button class="batch-btn batch-btn-delete" onclick="batchDelete('${e.base}')">üóëÔ∏è Delete All</button></div><div class="chunk-list">`,e.chunks.forEach(e=>{let t="";e.converting?t='<span class="chunk-status converting">‚öôÔ∏è Converting...</span>':e.upload_status&&"uploading"===e.upload_status.status?t='<span class="chunk-status uploading">‚òÅÔ∏è Uploading</span>':e.uploaded?t='<span class="chunk-status uploaded">‚úì Uploaded</span>':e.failed&&(t='<span class="chunk-status failed">‚úó Failed</span>');const o=!e.converting&&e.name.endsWith(".mp4")?`onclick="showPreview('${e.name}')"`:"";n+=`<div class="chunk-item" ${o}><span class="chunk-name">${e.name}</span><div class="chunk-info"><span class="chunk-size">${e.size} MB</span>${t}</div></div>`}),n+="</div></div>"}else{let t="";e.converting?t='<div class="status-badge converting">‚öôÔ∏è Converting...</div>':e.uploaded?t='<div class="status-badge uploaded">‚úì Uploaded</div>':e.upload_status?"uploading"===e.upload_status.status?t='<div class="status-badge uploading">‚òÅÔ∏è Uploading</div>':e.upload_status.status,e.failed&&(t='<div class="status-badge failed">‚úó Failed</div>');const o=!e.uploaded&&!e.converting&&"video"===e.type,a="image"===e.type,i="video"===e.type&&!e.converting;let d="";a&&(d=`<img src="/data/${e.name}" class="photo-preview" onclick="showPhotoPreview('${e.name}')" alt="Photo">`);const c=i?`onclick="showPreview('${e.name}')"`:"";n+=`<div class="media-item ${e.uploaded?"uploaded":""} ${e.failed?"failed":""}">${t}<div class="media-header" ${c}><div class="media-name">${"video"===e.type?"üé¨":"üì∑"} ${e.name}</div><div class="media-size">üíæ ${e.size} MB</div></div>${d}<div class="media-actions">${o?`<button class="action-btn btn-upload" onclick="event.stopPropagation(); uploadFile('${e.name}')">‚òÅÔ∏è Upload</button>`:""}<button class="action-btn btn-download" onclick="event.stopPropagation(); downloadFile('${e.name}')">‚¨áÔ∏è Download</button>${i?`<button class="action-btn btn-rename" onclick="event.stopPropagation(); showRenameModal('${e.name}')">‚úèÔ∏è Rename</button>`:""}<button class="action-btn btn-delete" onclick="event.stopPropagation(); deleteFile('${e.name}')">üóëÔ∏è Delete</button></div></div>`}}),t.innerHTML=n}).catch(()=>{})}function showPreview(e){document.getElementById("modalTitle").textContent=e,document.getElementById("previewVideo").src="/data/"+e,document.getElementById("previewModal").className="modal active",document.getElementById("mapLoading").style.display="block",document.getElementById("map").innerHTML="",document.getElementById("mapInfo").innerHTML="",fetch("/api/get_gps_data/"+e).then(e=>e.json()).then(e=>{if(document.getElementById("mapLoading").style.display="none",e.error)return void(document.getElementById("map").innerHTML='<div style="padding:20px;text-align:center;color:#666;">No GPS</div>');previewMap&&(previewMap.remove(),previewMap=null);const t=e.start,n=e.end;previewMap=L.map("map").setView([t.lat,t.lon],15),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap",maxZoom:19}).addTo(previewMap);const o=e.points.map(e=>[e.lat,e.lon]);L.polyline(o,{color:"#00ff88",weight:4,opacity:.8}).addTo(previewMap),L.marker([t.lat,t.lon]).bindPopup("Start").addTo(previewMap),L.marker([n.lat,n.lon]).bindPopup("End").addTo(previewMap);const a=L.latLngBounds(o);previewMap.fitBounds(a,{padding:[30,30]}),document.getElementById("mapInfo").innerHTML=`<div class="map-info-row"><span class="map-label">Start:</span><span class="map-value">${t.lat.toFixed(6)}, ${t.lon.toFixed(6)}</span></div><div class="map-info-row"><span class="map-label">End:</span><span class="map-value">${n.lat.toFixed(6)}, ${n.lon.toFixed(6)}</span></div><div class="map-info-row"><span class="map-label">Points:</span><span class="map-value">${e.points.length}</span></div><div class="map-info-row"><span class="map-label">Started:</span><span class="map-value">${t.timestamp}</span></div><div class="map-info-row"><span class="map-label">Ended:</span><span class="map-value">${n.timestamp}</span></div>`,setTimeout(()=>{previewMap&&previewMap.invalidateSize()},100)}).catch(()=>{document.getElementById("mapLoading").style.display="none",document.getElementById("map").innerHTML='<div style="padding:20px;text-align:center;color:#666;">Load failed</div>'})}function closePreview(){document.getElementById("previewModal").className="modal";const e=document.getElementById("previewVideo");e.pause(),e.src="",previewMap&&(previewMap.remove(),previewMap=null)}function showPhotoPreview(e){document.getElementById("photoTitle").textContent=e,document.getElementById("photoPreview").src="/data/"+e,document.getElementById("photoModal").className="photo-modal active",document.getElementById("photoInfo").innerHTML=`<div class="map-info-row"><span class="map-label">Filename:</span><span class="map-value">${e}</span></div>`}function closePhotoPreview(){document.getElementById("photoModal").className="photo-modal",document.getElementById("photoPreview").src=""}function batchUpload(e){confirm("Upload all?")&&fetch("/api/batch_upload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({base:e})}).then(e=>e.json()).then(e=>{alert(e.message),setTimeout(loadMedia,1e3)}).catch(()=>alert("Failed"))}function batchDelete(e){confirm("Delete ALL? Cannot undo!")&&fetch("/api/delete_batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({base:e})}).then(e=>e.json()).then(e=>{alert(e.message),loadMedia()}).catch(()=>alert("Failed"))}function uploadFile(e){fetch("/api/upload_cloud",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:e})}).then(()=>setTimeout(loadMedia,1e3)).catch(()=>alert("Failed"))}function downloadFile(e){window.location.href="/api/download/"+e}function deleteFile(e){confirm("Delete "+e+"?")&&fetch("/api/delete_file",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:e})}).then(()=>loadMedia()).catch(()=>alert("Failed"))}startGPS(),updateStatus(),loadMedia(),setInterval(updateStatus,1e3),setInterval(loadMedia,2e3),document.addEventListener("keydown",function(e){"Escape"===e.key&&(closePreview(),closePhotoPreview(),closeRenameModal())});
    </script>
</body>
</html>
